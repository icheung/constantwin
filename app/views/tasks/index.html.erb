<script type="text/javascript">
  function startTimer(elementID) {
    var ajax_updater = new Ajax.PeriodicalUpdater(
      elementID,
      '/tasks/time_left/' + elementID.substring(5).toString(),
      { method: 'get', frequency: 30, decay: 1 }
    );
    setInterval('checkTime("' + elementID.substring(5).toString() + '")', 5000);
  }
  function checkTime(taskId) {
    var timeLeft = parseInt(document.getElementById('timer' + taskId).innerHTML);
    if (timeLeft <= 0) {
      fail(taskId);
    }
  }
  function fail(taskId) {
      window.location = '/tasks/fail/' + taskId;
  }
</script>

<h1>Listing tasks</h1>

<table>
  <tr>
    <th>Description</th>
    <th>Duration</th>
    <th>Owner</th>
    <th>Is finished</th>
    <th>Time left</th>
  </tr>

<% @tasks.each do |task| %>
  <tr>
    <td><%=h task.description %></td>
    <td><%=h task.duration %></td>
    <td><%=h task.user_id %></td>
    <td><%=h task.is_finished %></td>
    <td>  
      <% if task.started_at %>  
        <% if task.duration - Time.at(Time.now - task.started_at.to_time).min > 0 %>
          <div id="timer<%=h task.id %>">
            <%= task.duration - Time.at(Time.now - task.started_at.to_time).min %>
          </div>
          <script type="text/javascript">startTimer('<%=h "timer" + task.id.to_s %>');</script>
        <% else %>
          <script type="text/javascript">//window.location="/tasks/fail/<%= task.id %>"</script>
          0
        <% end %>
      <% else %>
        <%= link_to 'Start', {:action => "start", :task_id => task.id} %>
      <% end %>
    </td>
    <td><%= link_to 'Edit', edit_task_path(task) %></td>
    <td><%= link_to 'Delete', task, :confirm => 'Are you sure?', :method => :delete %></td>
    <td><%= check_box_tag 'finished' %></td>
  </tr>
<% end %>
</table>

<br />

<%= link_to 'New task', new_task_path %>
